<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tool Auto D·ª± ƒêo√°n VIP (Secure) - Ph√¢n t√°ch Game</title>
    <style>
        /* GI·ªÆ NGUY√äN 100% CSS C·ª¶A D≈®NG */
        :root { --panel-scale: 1; --accent: #3366ff; --glass: rgba(32,36,45,0.6); --card:#0f1720; }
        html,body { margin:0;padding:0;height:100%;background:#0d0d12;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:#fff; }
        .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.7), rgba(2,6,12,0.85)); z-index:20000; }
        .panel-card { width:420px; max-width:94vw; border-radius:14px; padding:22px; box-shadow:0 18px 60px rgba(0,0,0,0.7); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
        .panel-card h2 { margin:0 0 6px 0; font-size:18px; text-align:center; text-transform: uppercase; }
        .sub { font-size:13px; color:#bdbdbd; text-align:center; margin-bottom:12px; }
        .price-grid { display:flex; gap:8px; justify-content:space-between; margin:12px 0; }
        .price-item { flex:1; background:rgba(255,255,255,0.02); padding:10px;border-radius:8px;text-align:center;font-weight:600; border:1px solid rgba(255,255,255,0.03); }
        .input-row { display:flex; gap:8px; margin-top:10px; }
        input[type="text"]{ flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.45);color:#fff;outline:none; }
        .btn { padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(180deg,var(--accent),#234ed6); color:#fff; transition: opacity 0.2s; }
        .btn-ghost { background:transparent;border:1px solid rgba(255,255,255,0.06); color:#ddd; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
        .msg { text-align:center; margin-top:10px; min-height:20px; font-size:14px; }
        .msg.success { color:#9effc9; } .msg.error { color:#ff9ea6; }
        #game-frame { width:100%; height:100vh; border: none; display:block; }
        #toggle-tool { position:fixed; top:15px; right:15px; z-index:10000; padding:10px 14px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:none; }
        #tool-panel { position:absolute; top:15px; right:15px; width:340px; background: rgba(20, 24, 34, 0.95); color: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.8); border: 1px solid #333; z-index:9999; overflow: hidden; backdrop-filter: blur(10px); resize: both; transform-origin: top right; transform: scale(var(--panel-scale)); display:none; }
        #tool-panel.horizontal { width: 560px; }
        #tool-panel.horizontal .pred-grid { grid-template-columns: 1fr 1fr 1fr; }
        .panel-header { background: linear-gradient(90deg, #ff3333, var(--accent)); padding:12px; display:flex; justify-content:space-between; align-items:center; }
        .header-title { font-weight:700; text-transform: uppercase; }
        .expire-badge { font-size:12px; background:rgba(255,255,255,0.05); padding:6px 8px; border-radius:8px; color:#ffd; }
        .panel-body { padding:12px; overflow:auto; display:flex; flex-direction:column; gap:12px; max-height: 80vh; }
        #btn-auto{ width:100%; padding:12px; background:linear-gradient(180deg,#ffd700,#ffaa00); color:#000; font-weight:700; border:none; border-radius:8px; cursor:pointer; }
        .bar-container { width:100%;height:28px;background:#222;border-radius:12px;display:flex;overflow:hidden;border:1px solid #444; }
        .bar-tai { height:100%;display:flex;align-items:center;padding-left:10px;background:#ff4d4d;color:#000; transition: width 0.5s; }
        .bar-xiu { height:100%;display:flex;align-items:center;justify-content:flex-end;padding-right:10px;background:#4da6ff;color:#000; transition: width 0.5s; }
        .pred-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .pred-box{background:#1a1e29;padding:10px;border-radius:8px;text-align:center;border:1px solid #333;}
        .pred-final{grid-column:span 2;background:linear-gradient(45deg,#2a2a3a,#1a1e29);border:1px solid #ffd700;padding:12px;}
        .color-tai { color: #ff4d4d; } .color-xiu { color: #4da6ff; }
        .toggle-btn { padding:6px 8px; border-radius:8px; border:1px solid #444; background:transparent; color:#fff; cursor:pointer; }
        .toggle-btn.active { background:#2a2a3a; border-color:#888; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100000; }
        .toast { background: rgba(20, 24, 34, 0.95); color: #fff; padding: 12px 20px; border-radius: 8px; border-left: 4px solid #3366ff; margin-top: 10px; animation: toast-in 0.3s; }
        @keyframes toast-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="gameSelectOverlay" class="overlay">
        <div class="panel-card">
            <h2>üéÆ CH·ªåN GAME S·ª¨ D·ª§NG TOOL</h2>
            <div class="sub">Vui l√≤ng ch·ªçn c·ªïng game b·∫°n mu·ªën d·ª± ƒëo√°n</div>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:20px;">
                <button id="btn-select-lc79" class="btn" style="background:linear-gradient(180deg,#00c853,#00b44a); padding: 14px;">M·ªû TOOL LC79</button>
                <button id="btn-select-xd88" class="btn" style="background:linear-gradient(180deg,#f39c12,#d35400); padding: 14px;">M·ªû TOOL XOCDIA88</button>
            </div>
        </div>
    </div>

    <div id="entryOverlay" class="overlay" style="display:none;">
        <div class="panel-card">
            <h2 id="entryTitle">üîê K√≠ch ho·∫°t VIP - <span id="gameNameDisplay" style="color:#ffd700;"></span></h2>
            <div class="sub">Nh·∫≠p key c·ªßa b·∫°n. B·∫£ng gi√°:</div>
            <div class="price-grid">
                <div class="price-item">49k/1D</div>
                <div class="price-item">99k/7D</div>
                <div class="price-item">199k/30D</div>
            </div>
            <div class="input-row">
                <input id="keyInput" type="text" placeholder="Nh·∫≠p key..." autocomplete="off" />
                <button id="checkBtn" class="btn">KI·ªÇM TRA</button>
            </div>
            <div id="entryMsg" class="msg"></div>
            <button id="backToGameSelectBtn" class="btn-ghost" style="width:100%; margin-top:10px;">‚¨Ö Quay l·∫°i ch·ªçn game</button>
        </div>
    </div>

    <iframe id="game-frame" src="about:blank" style="width:100%;height:100vh;border:0;display:none;"></iframe>
    <button id="toggle-tool" onclick="togglePanel()">M·ªû TOOL</button>

    <div id="tool-panel">
        <div class="panel-header" id="panel-header">
            <div class="header-title" id="tool-title">üéØ TOOL D·ª∞ ƒêO√ÅN</div>
            <div style="display:flex;align-items:center;gap:8px">
                <div id="expireBadge" class="expire-badge">Key: --</div>
                <button onclick="togglePanel()" style="background:none;border:none;color:white;cursor:pointer;font-size:20px;">√ó</button>
            </div>
        </div>

        <div class="panel-body">
            <button id="btn-auto" onclick="fetchApiAndPredict()">üîÑ C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU C·∫¶U</button>

            <div id="panel-settings" style="display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; gap:8px;">
                    <select id="seq-length-select" style="flex:1; padding:8px; border-radius:8px; background:#1a1e29; color:white; border:1px solid #333;">
                        <option value="11">D√†i 11</option>
                        <option value="13" selected>D√†i 13</option>
                        <option value="15">D√†i 15</option>
                    </select>
                    <select id="api-source-select" style="flex:1; padding:8px; border-radius:8px; background:#1a1e29; color:white; border:1px solid #333;">
                        <option value="normal">B√†n th∆∞·ªùng</option>
                        <option value="md5">B√†n MD5</option>
                    </select>
                </div>

                <div style="font-size:12px; display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <label><input type="checkbox" id="skip-dice-checkbox" /> B·ªè x√∫c x·∫Øc</label>
                    <label><input type="checkbox" id="hide-suggestion-checkbox" /> ·∫®n g·ª£i √Ω</label>
                    <label><input type="checkbox" id="invert-chain-checkbox" /> B·∫ª chu·ªói</label>
                    <label><input type="checkbox" id="invert-final-checkbox" /> B·∫ª k·∫øt qu·∫£</label>
                </div>

                <div style="display:flex; gap:5px;">
                    <button id="btn-invert-all" class="toggle-btn" style="flex:1; font-size:11px;">ƒê·∫£o to√†n b·ªô</button>
                    <button id="btn-invert-chain" class="toggle-btn" style="flex:1; font-size:11px;">ƒê·∫£o chu·ªói</button>
                </div>
            </div>

            <div id="result-box">
                <div style="text-align:center;color:#888;padding:20px 0;"><i>Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y b·∫•m c·∫≠p nh·∫≠t...</i></div>
            </div>
        </div>
    </div>

<script>
const KEY_SERVER_URL = "https://vip-key-server.onrender.com";
let selectedGame = '';
let currentKey = '';
let audioCtx = null;

// --- 1. HWID CANVAS (CH·ªêT B·∫¢O M·∫¨T) ---
async function getHWID() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = "top";
    ctx.font = "14px 'Arial'";
    ctx.fillText("Dung-Vip-Tool-" + screen.width, 2, 2);
    const b64 = canvas.toDataURL().slice(-30);
    let hash = 0;
    for (let i = 0; i < b64.length; i++) {
        hash = ((hash << 5) - hash) + b64.charCodeAt(i);
        hash |= 0;
    }
    return "HW-" + Math.abs(hash).toString(16).toUpperCase();
}

// --- 2. TOAST & SOUND (GI·ªÆ NGUY√äN) ---
function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast \${type}`;
    toast.innerHTML = msg;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
}

function playBeep(type) {
    try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(type === 'high' ? 800 : 400, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    } catch(e){}
}

// --- 3. D·ª∞ ƒêO√ÅN (ƒê√É ƒê·ªíNG B·ªò ƒê∆Ø·ªúNG D·∫™N /predict) ---
async function fetchApiAndPredict() {
    const btn = document.getElementById("btn-auto");
    const resultBox = document.getElementById("result-box");
    btn.innerHTML = "‚è≥ ƒêANG X·ª¨ L√ù...";
    btn.disabled = true;

    try {
        const hwid = await getHWID();
        // S·ª¨A T·∫†I ƒê√ÇY: /get-prediction-v2 -> /predict
        const response = await fetch(KEY_SERVER_URL + "/predict", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                key: currentKey,
                hwid: hwid,
                game: selectedGame,
                source: document.getElementById('api-source-select').value,
                seqLen: document.getElementById('seq-length-select').value
            })
        });

        const data = await response.json();
        if (!data.success) {
            showToast(data.message, "error");
            return;
        }

        let finalKQ = data.ket_qua;
        const invertChain = document.getElementById('invert-chain-checkbox').checked;
        const invertFinal = document.getElementById('invert-final-checkbox').checked;
        const invertAllBtn = document.getElementById('btn-invert-all').classList.contains('active');

        const reverse = (k) => k === 'T√†i' ? 'X·ªâu' : (k === 'X·ªâu' ? 'T√†i' : k);
        if(invertChain || invertFinal || invertAllBtn) finalKQ = reverse(finalKQ);

        const getCls = (k) => k.includes('T√†i') ? 'color-tai' : (k.includes('X·ªâu') ? 'color-xiu' : '');
        
        resultBox.innerHTML = `
            <div class="info-row" style="background:#1a1e29;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #333;">
                <div style="color:#aaa; font-size:12px; margin-bottom:4px;">Chu·ªói c·∫ßu:</div>
                <div style="letter-spacing:2px; font-weight:bold; color:#ffd700;">\${data.chuoi}</div>
            </div>
            <div class="bar-container">
                <div class="bar-tai" style="width: \${data.ptTai}%">\${data.ptTai}%</div>
                <div class="bar-xiu" style="width: \${data.ptXiu}%">\${data.ptXiu}%</div>
            </div>
            <div class="pred-grid" style="margin-top:10px;">
                <div class="pred-box">
                    <div style="font-size:10px; color:#888;">X√öC X·∫ÆC</div>
                    <div style="font-weight:bold;">\${data.lastDice.join("-") || "?"}</div>
                </div>
                <div class="pred-box pred-final">
                    <div style="font-size:11px;">üî• K·∫æT QU·∫¢ CH·ªêT üî•</div>
                    <div class="\${getCls(finalKQ)}" style="font-size:22px; font-weight:900;">\${finalKQ}</div>
                </div>
            </div>
            \${data.cau_bip ? \`<div style="text-align:center; color:#ff4d4d; font-size:11px; margin-top:5px;">‚ö†Ô∏è \${data.cau_bip}</div>\` : ''}
        `;

        if (Math.max(data.ptTai, data.ptXiu) >= 80) playBeep('high');
        showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");

    } catch (e) {
        showToast("L·ªói k·∫øt n·ªëi Server d·ª± ƒëo√°n", "error");
    } finally {
        btn.innerHTML = "üîÑ C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU C·∫¶U";
        btn.disabled = false;
    }
}

// --- 4. KH·ªûI T·∫†O & S·ª∞ KI·ªÜN (GI·ªÆ NGUY√äN) ---
document.getElementById('btn-select-lc79').onclick = () => { selectedGame='lc79'; openEntry(); };
document.getElementById('btn-select-xd88').onclick = () => { selectedGame='xd88'; openEntry(); };
document.getElementById('backToGameSelectBtn').onclick = () => { 
    document.getElementById('entryOverlay').style.display='none'; 
    document.getElementById('gameSelectOverlay').style.display='flex'; 
};

function openEntry() {
    document.getElementById('gameSelectOverlay').style.display='none';
    document.getElementById('entryOverlay').style.display='flex';
    document.getElementById('gameNameDisplay').innerText = selectedGame.toUpperCase();
}

document.getElementById('checkBtn').onclick = async () => {
    const key = document.getElementById('keyInput').value.trim();
    if(!key) return;
    const hwid = await getHWID();
    const btn = document.getElementById('checkBtn');
    btn.disabled = true;

    try {
        const res = await fetch(KEY_SERVER_URL + "/check-key", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ key, hwid, game: selectedGame })
        });
        const data = await res.json();
        if(data.success) {
            currentKey = key;
            document.getElementById('entryOverlay').style.display='none';
            const frame = document.getElementById('game-frame');
            frame.src = selectedGame === 'lc79' ? "https://lc79b.bet/" : "https://play.xocdia88.green/";
            frame.style.display = 'block';
            document.getElementById('tool-panel').style.display = 'block';
            document.getElementById('tool-title').innerText = "TOOL VIP " + selectedGame.toUpperCase();
            showToast("ƒê√£ k√≠ch ho·∫°t!", "success");
        } else {
            document.getElementById('entryMsg').className = "msg error";
            document.getElementById('entryMsg').innerText = data.message;
        }
    } catch(e) { showToast("L·ªói server", "error"); }
    btn.disabled = false;
};

document.getElementById('btn-invert-all').onclick = function() { this.classList.toggle('active'); };
document.getElementById('btn-invert-chain').onclick = function() { this.classList.toggle('active'); };

function togglePanel() {
    const p = document.getElementById('tool-panel');
    const b = document.getElementById('toggle-tool');
    if(p.style.display === 'none') { p.style.display='block'; b.style.display='none'; }
    else { p.style.display='none'; b.style.display='block'; }
}

const header = document.getElementById("panel-header");
const panel = document.getElementById("tool-panel");
let isDragging=false, ox=0, oy=0;
header.onmousedown = (e) => { isDragging=true; ox=e.clientX-panel.offsetLeft; oy=e.clientY-panel.offsetTop; };
document.onmousemove = (e) => { if(isDragging) { panel.style.left=(e.clientX-ox)+'px'; panel.style.top=(e.clientY-oy)+'px'; panel.style.right='auto'; } };
document.onmouseup = () => isDragging=false;
</script>
</body>
</html>
